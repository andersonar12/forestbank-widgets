<div>
  <!-- Tools and dependencies -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  />

  <!-- Vue.js Library -->
  <script src="https://unpkg.com/vue@2.6.12"></script>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

  <!-- HTML - Render -->
  <div class="ecological-widget-container">
    <img :src="urlImg + 'border-top.png'" class="img-fluid" alt="..." />

    <!-- Imagen principal -->
    <div class="main-image-container">
      <img src="{{imagen_principal}}" class="main-image img-fluid" alt="Imagen principal" />
      <img :src="urlImg + 'forest-bank-logo-white.png'" class="logo" alt="Logo" />
    </div>

    <!-- Titulo -->
    <div class="title">
      <div class="container">
        <div class="row">
          <div class="col project-name">{{cabezera_titulo|raw}}</div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row d-flex justify-content-center">
        <!-- <div class="col" style="max-width: 840px"> -->
        <div class="col">
          <div class="divider"></div>

          <div class="description-container">
            <div class="description-content" ref="content" :style="{ height: contentHeight }">
              {{descripcion|raw}}
            </div>
            <button
              class="toggle-btn"
              v-html="isExpanded ? '−' : '+'"
              @click="toggleDescription"
            ></button>
            <!-- <div class="d-flex justify-content-end">
            </div> -->
          </div>

          <div class="row mt-5 d-flex justify-content-center">
            <div class="col-12 col-md-9">
              <div class="row">
                <!-- Localización -->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-4">
                    <img :src="urlImg + 'marker.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Localización</h6>
                      <p>{{localizacion|raw}}</p>
                    </div>
                  </div>
                </div>

                <!-- Area -->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-3">
                    <img :src="urlImg + 'people.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Area</h6>
                      <p>{{area|raw}}</p>
                    </div>
                  </div>
                </div>

                <!-- Registro -->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-4">
                    <img :src="urlImg + 'carpet.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Registro</h6>
                      <p>{{registro_permanencia|raw}}</p>
                    </div>
                  </div>
                </div>

                <!-- Especies -->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-3">
                    <img :src="urlImg + 'tree.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Especies</h6>
                      <p>{{especies|raw}}</p>
                    </div>
                  </div>
                </div>
                <!-- Créditos de carbono-->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-4">
                    <img :src="urlImg + 'heards-gear.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Créditos de carbono</h6>
                      <p>{{creditos_de_carbono|raw}}</p>
                    </div>
                  </div>
                </div>

                <!-- Precios -->
                <div class="col-12 col-md-6">
                  <div class="info-item d-flex mb-3">
                    <img :src="urlImg + 'currency.png'" class="logo" alt="..." />
                    <div class="ms-3">
                      <h6 class="fw-bolder subtitle">Precios*</h6>
                      <p>{{precios|raw}}</p>
                    </div>
                  </div>
                </div>
                <!-- DSG'S alcanzados -->
                <!-- <div class="col-12 col-md-6">
                    <div class="info-item d-flex mb-3">
                      <img :src="urlImg + 'ods-logo.png'" class="logo" alt="..." />
                      <div class="ms-3">
                        <h6 class="fw-bolder subtitle">DSG'S alcanzados</h6>
                        <ul>
                          <li>
                            1/3 Indicadores
                            <p class="mb-1 indicators">
                              Reducción anual de la concentración de partículas (ug/m3)
                            </p>
                          </li>
                          <li>
                            2/3 Indicadores
                            <p class="mb-1 indicators">
                              Emisiones de CO2 per cápita relacionadas con la energía
                            </p>
                            <p class="mb-1 indicators">Vulnerabilidad al cambio climático (0-1)</p>
                          </li>

                          <li>
                            3/3 Indicadores
                            <p class="mb-1 indicators">Lista roja de supervivencia de especies (0-1)</p>
                            <p class="mb-1 indicators">Variación anual de la superficie forestal (%)</p>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div> -->
              </div>
            </div>

            <div class="col-12 col-md widget">
              <div class="widget-container">
                <!-- Precio -->
                <div class="price d-flex justify-content-between">
                  <div class="w-50" style="width: 40%">
                    <p class="text-black fw-bolder" v-text="'Precio'"></p>
                  </div>
                  <div class="text-end" style="width: 60%">
                    <p style="color: #808080">
                      <span class="fw-bolder text-black" v-text="price + ' €'"></span> / bono CO2
                    </p>
                    <span style="font-size: 13px; color: #808080"
                      >Cada bono de carbono equivale a 1 tonelada de CO2
                    </span>
                  </div>
                </div>

                <hr style="color: #808080" />
                <!-- Cantidad  -->
                <div class="quantity d-flex justify-content-between w-100">
                  <p style="color: #808080">Cantidad</p>

                  <div class="input-container">
                    <div class="input-group input-group-sm">
                      <button class="btn btn-light" type="button" @click="decrement">--</button>

                      <input type="number" v-model="quantity" class="form-control" placeholder="" />

                      <button class="btn btn-light" type="button" @click="increment">+</button>
                    </div>
                  </div>
                </div>
                <hr style="color: #808080" />
                <!-- Available Stock  -->
                <div class="d-flex justify-content-between" style="color: #808080">
                  <p>Stock disponible</p>
                  <p><span class="">7500</span> Tn</p>
                </div>
                <hr style="color: #808080" />
                <!-- Rates  -->
                <div class="d-flex justify-content-between" style="color: #808080">
                  <p>IVA (21%)</p>
                  <p v-text="IVA + ' €'"></p>
                </div>
                <hr style="color: #808080" />
                <!-- Total  -->
                <div class="d-flex justify-content-between">
                  <p style="color: #808080">Total</p>
                  <p class="fw-bold text-black mb-0"><span v-text="total"></span> €</p>
                </div>

                <hr style="color: #808080" />
                <!-- Buttons -->
                <button class="buy-button btn btn-primary mb-3" @click="buyCarbonCredits()">
                  <span>Comprar</span> <span class="" v-text="total + ' €'"></span>
                </button>

                <!-- Reservar -->
                <button class="contact-button btn btn-outline-primary" @click="contactAlert()">
                  <span>Reservar</span> <span>➜</span>
                </button>
              </div>
            </div>
          </div>

          <!-- <div class="row mt-5"></div> -->
        </div>
        <p />
      </div>
    </div>
    <img :src="urlImg + 'border-bottom.png'" class="img-fluid" alt="..." />
  </div>

  <!--Logic  -->
  <script>
    // App Principal
    class EcologicalWidget {
      constructor(elementId) {
        // Definir el componente dentro del constructor con un nombre único
        const formComponentName = `form-component-${elementId}`;

        // Formulario de contacto
        Vue.component(formComponentName, {
          props: {
            instanceId: String, // Cambiamos widgetId por instanceId para evitar conflictos
          },
          template: `
  <div :id="'form-' + instanceId">
    <div class="mb-3">
      <label :for="'email-' + instanceId">Email:</label>
      <input
        type="email"
        class="form-control"
        v-model="formData.email"
        :id="'email-' + instanceId"
        autocomplete="off"
      />
      <p class="error-message" v-show="errors.email">*Por favor, introduce un correo electrónico valido</p>
    </div>
    <div class="mb-3">
      <label :for="'name-' + instanceId">Nombre:</label>
      <input
        type="text"
        class="form-control"
        v-model="formData.name"
        :id="'name-' + instanceId"
        autocomplete="off"
      />
      <p class="error-message" v-show="errors.name">*Por favor, introduce tu nombre</p>
    </div>
    <div class="mb-3">
      <label :for="'firstSurname-' + instanceId">Primer Apellido:</label>
      <input
        type="text"
        class="form-control"
        v-model="formData.firstSurname"
        :id="'firstSurname-' + instanceId"
        autocomplete="off"
      />
      <p class="error-message" v-show="errors.firstSurname">*Por favor, introduce tu primer apellido</p>
    </div>
    <div class="mb-3">
      <label :for="'secondSurname-' + instanceId">Segundo Apellido:</label>
      <input
        type="text"
        class="form-control"
        v-model="formData.secondSurname"
        :id="'secondSurname-' + instanceId"
        autocomplete="off"
      />
      <p class="error-message" v-show="errors.secondSurname">*Por favor, introduce tu segundo apellido</p>
    </div>
    <div class="mb-3">
      <label :for="'description-' + instanceId">Mensaje:</label>
      <textarea
        class="form-control"
        v-model="formData.description"
        :id="'description-' + instanceId"
        autocomplete="off"
      ></textarea>
    </div>
    <div class="button-container">
      <button class="btn btn-primary" @click="handleSubmit">
        Enviar
        <div v-if="isSending" class="spinner-border spinner-border-sm" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </button>
    </div>
  </div>
`,
          data() {
            return {
              baseUrl: "https://artemisaengine.com",
              formData: {
                email: "",
                name: "",
                firstSurname: "",
                secondSurname: "",
                description: "",
                requestInformation: true,
              },
              errors: { email: "", name: "", firstSurname: "", secondSurname: "" },
              isSending: false,
            };
          },
          methods: {
            regexEmail(email) {
              //Email
              const regexMail = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;

              return regexMail.test(email);
            },
            validateErrors() {
              // debugger;

              this.errors["email"] = !this.regexEmail(this.formData.email) ? true : false;

              this.errors["name"] = !this.formData.name ? true : false;

              this.errors["firstSurname"] = !this.formData.firstSurname ? true : false;

              this.errors["secondSurname"] = !this.formData.secondSurname ? true : false;
            },
            handleSubmit() {
              this.validateErrors();

              if (Object.values(this.errors).every((e) => e === false)) {
                // &&  Object.values(this.formData).every((e) => e !== "")

                this.formData["projectName"] = `{{cabezera_titulo|raw}}`;

                this.isSending = true;

                fetch(`${this.baseUrl}/marketplace/postLead`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(this.formData),
                })
                  .then((response) => response.text())
                  .then((response) => {
                    console.log(response);
                    if (response === "OK") {
                      Swal.fire({
                        icon: "success",
                        title: "Gracias por tu reserva, nos pondremos en contacto contigo.",
                        confirmButtonText: "Aceptar",
                        customClass: {
                          popup: "custom-modal",
                        },
                        width: 600,
                      });
                    } else {
                      Swal.close();
                    }
                  })
                  .catch((error) => {
                    console.error("Error:", error);
                  })
                  .finally(() => (this.isSending = false));
              }
            },
            cancel() {
              Swal.close(); // Cerrar el modal al hacer clic en Cancelar
            },
          },
        });

        this.app = new Vue({
          el: `#${elementId}`,
          name: "ecological-information",
          data() {
            return {
              baseUrl: "https://artemisaengine.com",
              urlImg: "https://forestbank.es/wp-content/uploads/2025/01/",
              isExpanded: false,
              contentHeight: "100px",
              price: 100,
              quantity: 1,
              projectSelected: null,
              instanceId: elementId, // Cambiamos widgetId por instanceId
            };
          },
          methods: {
            toggleDescription() {
              const content = this.$refs.content;
              if (!this.isExpanded) {
                this.contentHeight = content.scrollHeight + "px";
              } else {
                this.contentHeight = "100px";
              }
              this.isExpanded = !this.isExpanded;
            },
            increment() {
              this.quantity++;
            },
            decrement() {
              if (this.quantity > 1) {
                this.quantity--;
              }
            },
            stripHtml(html) {
              const temp = document.createElement("div");
              temp.innerHTML = html;
              const plainText = temp.textContent || temp.innerText;

              // Limpiamos espacios extra y saltos de línea innecesarios
              return plainText.trim().replace(/\s+/g, " ");
            },
            buyCarbonCredits() {
              if (this.quantity >= 11 && this.quantity <= 20) {
                this.openPriceAlert();
                return;
              } else if (this.quantity >= 21 && this.quantity <= 50) {
                this.openPriceAlert();
                return;
              } else if (this.quantity >= 51 && this.quantity <= 100) {
                this.openPriceAlert();
                return;
              }

              let title =
                document.getElementsByClassName("project-name")[
                  Number(this.instanceId.split("-")[1])
                ].innerHTML;

              let image =
                document.getElementsByClassName("main-image")[Number(this.instanceId.split("-")[1])]
                  .src;

              let project = {
                title: this.stripHtml(title),
                image,
              };

              Cookies.set("project-selected", JSON.stringify(project), { expires: 1 });
              Cookies.set("carbon-credits", this.quantity, { expires: 1 });
              window.location.href = "https://forestbank.es/marketplace/";
            },
            contactAlert() {
              const formComponent = Vue.extend(Vue.component(formComponentName));
              const instance = new formComponent({
                propsData: {
                  instanceId: this.instanceId,
                },
              });
              instance.$mount();

              Swal.fire({
                title: "Reservar 👋",
                html: instance.$el,
                showCancelButton: false,
                showConfirmButton: false,
                customClass: {
                  popup: "custom-modal",
                  container: `modal-${this.instanceId}`,
                },
                didOpen: () => {
                  const modalElement = document.querySelector(`.modal-${this.instanceId}`);
                  if (modalElement) {
                    modalElement.style.zIndex = "9999";
                  }
                },
              });
            },
            openPriceAlert() {
              Swal.fire({
                // icon: "warning",
                imageUrl: "https://forestbank.es/wp-content/uploads/2022/06/forest-bank-logo.png",
                imageWidth: 250,
                title: "Ha elegido mas de diez creditos",
                text: "Para comprar más de 10 créditos, por favor escríbenos a hola@forestbank.es",
                confirmButtonText: "Aceptar",
                customClass: {
                  popup: "custom-modal",
                },
              });
            },
          },
          mounted() {
            this.$nextTick(() => {
              this.contentHeight = "100px";
            });
          },
          computed: {
            IVA() {
              const iva = this.price * this.quantity * 0.21; // 21% IVA
              return parseFloat(iva.toFixed(2));
            },
            total() {
              return this.price * this.quantity + this.IVA;
            },
          },
          watch: {
            quantity(value) {
              if (value < 1) {
                this.quantity = 1;
              }

              if (value > 10) {
                this.quantity = 10;
              }
            },
          },
        });
      }
    }

    // Función para inicializar widgets
    function initEcologicalWidgets() {
      const widgets = document.querySelectorAll(".ecological-widget-container");
      widgets.forEach((widget, index) => {
        const uniqueId = `eco-${index}-${Date.now()}`;
        widget.id = uniqueId;
        new EcologicalWidget(uniqueId);
      });
      // widgets.forEach((widget, index) => {
      //   const uniqueId = `ecological-information-${index}`;
      //   widget.id = uniqueId;
      //   new EcologicalWidget(uniqueId);
      // });
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener("DOMContentLoaded", initEcologicalWidgets);
  </script>
  <!--Logic  -->

  <style>
    .ecological-widget-container {
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      ul,
      li {
        font-family: "Montserrat", sans-serif !important;
      }
      font-family: "Montserrat", sans-serif !important;

      font-weight: 400;
      font-style: normal;
      font-size: 22px;
      color: white;
      background-color: #114414;
      /* padding-top: 125px;
      padding-bottom: 50px; */

      .title {
        background-color: #6dc08e;
        h1 {
          text-transform: uppercase;

          font-weight: bold;
          font-size: clamp(2rem, 5vw, 5rem); /* Mínimo 2rem, preferido 5vw, máximo 4rem */
        }
        padding-top: 15px;
        padding-bottom: 30px;
      }

      .divider {
        height: 0.5rem; /* Ajusta el grosor */
        background-color: white;
        width: 15%; /* Ancho relativo al contenedor */
        /* O puedes usar: width: clamp(80px, 15%, 150px); para tener límites */
        margin: 2.5rem 0;
      }

      .description-container {
        display: grid;
        grid-template-columns: 1fr 40px;
        gap: 10px;
      }

      .description-content {
        color: white;
        overflow: hidden;
        transition: height 0.3s ease-out;
        grid-column: 1;
      }

      .toggle-btn {
        grid-column: 2;
        align-self: end; /* Alinea con la última línea */
        background: none;
        border: 2px solid white;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 38px;
        padding: 0;
        line-height: 1;
        margin-bottom: 5px; /* Ajusta según necesites */
      }

      .toggle-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .main-image-container {
        position: relative;
        width: 100%;
        .main-image {
          width: 100%;
          height: auto;
        }

        .logo {
          position: absolute;
          top: 45px; /* Ajusta la distancia desde arriba */
          left: 32px; /* Ajusta la distancia desde la izquierda */
          width: 210px; /* Ajusta el tamaño del logo */
          height: auto;
          z-index: 1;
        }

        /* Media query para ajustar el tamaño del logo en pantallas pequeñas */
        @media (max-width: 768px) {
          .logo {
            top: 20px; /* Ajusta la distancia desde arriba */
            left: 20px; /* Ajusta la distancia desde la izquierda */
            width: 120px;
          }
        }
      }

      .info-item {
        .ms-3 {
          /* overflow-wrap: break-word; */
          word-wrap: break-word;
        }
        .subtitle {
          font-size: 26px;
          width: 100%;
          white-space: normal !important; /* Fuerza el salto de línea */
          overflow-wrap: break-word;
          word-wrap: break-word;
        }
        p,
        ul {
          font-size: 19px;
        }
        ul {
          padding-left: 1rem;
        }

        .indicators {
          font-size: 15px;
        }

        .logo {
          height: 50px !important;
          width: 50px !important;
          min-width: 50px !important;
        }
      }

      .widget {
        font-size: 17px;
        max-width: 330px;
        position: relative;

        p {
          margin-bottom: 0px;
        }
        .floating-fixed {
          position: fixed;
          top: 0; /* Fijar en la parte superior de la ventana */
        }

        .floating-stopped {
          position: absolute;
          bottom: 0; /* El cuadro flotante se queda en su lugar al final */
        }

        hr {
          margin: 1rem 0 !important;
        }

        .widget-container {
          background-color: #fff;
          padding: 24px;
          width: 318px;
          box-shadow: 0 40px 80px rgba(0, 0, 0, 0.08), 0 16px 30px rgba(0, 0, 0, 0.08),
            0 10px 18px rgba(0, 0, 0, 0.08), 0 5px 10px rgba(0, 0, 0, 0.08),
            0 3px 6px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.08);
          border-radius: 8px;

          .price {
            .img-project {
              box-shadow: 0px 2px 1px -1px rgba(0, 0, 0, 0.2), 0px 1px 1px 0px rgba(0, 0, 0, 0.14),
                0px 1px 3px 0px rgba(0, 0, 0, 0.12);
              border-radius: 8px;
              height: 56px !important;
              width: 72px !important;
            }
          }

          .quantity {
            .input-group {
              width: 180px;
            }

            button {
              border: 2px solid #d9d9d9 !important;
              width: 35px;
            }

            input {
              border-top: 2px solid #d9d9d9 !important;
              border-bottom: 2px solid #d9d9d9 !important;
              font-size: 20px;
              color: black;

              &[type="number"] {
                display: inline-block;
                text-align: center;
                font-size: 16px !important;

                &::-webkit-inner-spin-button {
                  -webkit-appearance: none;
                }
              }
            }
          }

          .btn-primary {
            background-color: #006a32 !important;
            border-color: #006a32 !important;
            color: #fff;
          }

          .btn-primary:hover,
          .btn-primary:focus {
            background-color: #006a32dc !important;
            border-color: #006a32dc !important;
          }

          .btn-outline-primary {
            border-color: #006a32 !important;
            color: #006a32;
          }

          .btn-outline-primary:hover,
          .btn-outline-primary:focus {
            background-color: #006a32 !important;
            border-color: #006a32 !important;
            color: #fff;
          }

          .form-control:focus {
            border-color: #04ab52d0 !important;
            box-shadow: 0 0 0 0.1rem rgba(0, 106, 50, 0.693);
          }

          .buy-button,
          .contact-button {
            width: 100%;
            height: 48px;
            font-size: 20px;
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
        }

        @media (max-width: 767px) {
          max-width: 100%;
          display: flex;
          justify-content: center;
        }
      }
    }
    .custom-modal {
      color: black !important;
      font-family: "Roboto", sans-serif !important;
      max-width: 380px;

      .swal2-image {
        max-width: 100%;
        margin: 2em auto 0;
      }

      .swal2-title {
        color: black !important;
      }

      .swal2-content {
        color: #555 !important;
      }

      .error-message {
        color: red;
        font-size: 14px;
      }

      .form-control:focus {
        border-color: #04ab52d0 !important;
        box-shadow: 0 0 0 0.1rem rgba(0, 106, 50, 0.693);
      }

      .button-container {
        button {
          width: 200px;
          font-size: 20px;
          border-radius: 24px;
          padding: 8px 16px;
          cursor: pointer;
          transition: transform 0.2s ease-in-out;

          &:hover {
            transform: scale(1.1);
          }
        }

        .btn-primary {
          background-color: #006a32 !important;
          border-color: #006a32 !important;
          color: #fff;
        }

        .btn-primary:hover,
        .btn-primary:focus {
          background-color: #006a32dc !important;
          border-color: #006a32dc !important;
        }
      }
    }
  </style>
</div>
